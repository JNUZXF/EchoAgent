"""
工具集成优化总结与新增指南
文件路径: docs/工具集成优化总结与新增指南.md
功能: 总结本次对工具系统的优化方案与改动点, 并给出后续新增工具的标准流程与示例。
"""

### 1. 背景与目标

- 本项目原有工具以手写字典/示例为主, 难以维护和扩展。
- 本次优化采用 “代码即定义” 的方式: 使用 Pydantic 模型 + `@tool` 装饰器自动生成 JSON Schema, 并通过统一的 `ToolRegistry` 完成注册与执行。

### 2. 关键改动

- 新增 `tools_agent/toolkit.py`
  - 提供 `@tool` 装饰器, 自动从参数模型生成 JSON Schema。
  - 提供 `ToolRegistry` 统一存储工具、Schema 并负责执行。

- 新增 `tools_agent/builtin_tools.py`
  - 将内置工具 `CodeRunner` 与 `continue_analyze` 以 `@tool` 方式暴露, 并定义其 Pydantic 参数模型。

- 修改 `agent_frame.py`
  - 在 `AgentToolManager` 中集成 `ToolRegistry`。
  - 优先使用注册表提供的 Schema 给到 LLM, 兼容旧的本地工具配置回退。
  - 工具执行优先走注册表, 保持向后兼容。

- 更新 `requirements.txt`
  - 增加 `pydantic` 依赖。

### 3. 架构关系

- `@tool` 装饰的函数 => 自动产生工具 Schema。
- `ToolRegistry.register()` => 收集 name -> 可调用、name -> 参数模型、schemas 列表。
- `AgentToolManager`
  - `get_all_tool_configs_for_prompt()` 返回 `ToolRegistry` 的 Schema 列表(首选), 供提示词使用。
  - `execute_tool(tool_name, **kwargs)` 调用 `ToolRegistry.execute()` 执行具体工具。

### 4. 新增工具标准流程

1) 在 `tools_agent/` 新建或追加一个工具文件(推荐按业务分组):

```python
from pydantic import BaseModel, Field
from tools_agent.toolkit import tool

class MyToolArgs(BaseModel):
    question: str = Field(..., description="用户问题, 需提供充分上下文")

@tool
def my_tool(args: MyToolArgs):
    """你的工具做什么"""
    # TODO: 实现你的逻辑
    return {"answer": f"收到: {args.question}"}
```

2) 在 `agent_frame.py` 的 `_register_local_tools` 中注册:

```python
from tools_agent.my_tools import my_tool
self.tool_manager.register_tool_function(my_tool)
```

3) 无需手写 Schema。提示词中 `tools` 将自动包含该工具的 JSON Schema。

4) LLM 工具调用时, 会以 `{"tools": ["my_tool(question=\"...\")"]}` 的格式识别名称。框架在执行阶段会将参数 JSON 化后送入 `ToolRegistry` 进行 Pydantic 校验并调用。

### 5. 兼容性说明

- 保留原 `LocalToolManager` 与 `tools_configs.py` 用作回退。
- 当注册表存在工具 Schema 时, 优先输出新 Schema 给 LLM, 保证行为一致性并减少手写配置。

### 6. 日志与可观测性

- 仍沿用原有会话日志系统。工具开始/结束事件通过流式输出的 JSON 片段发送到前端。
- 如需为单个工具增加更细粒度日志, 建议在工具实现内部增加 `print/logging` 并由会话日志捕获。

### 7. 常见问题

- 工具未被识别: 确认 `@tool` 正确装饰且在 `_register_local_tools` 已调用 `register_tool_function()`。
- 参数校验失败: 检查 Pydantic 模型字段、类型与描述; LLM 的调用参数需能被 `model_validate_json` 正确解析。

### 8. 后续扩展建议

- 按业务域拆分工具文件, 维持单文件职责与规模上限, 便于维护。
- 在 `docs/` 下为复杂工具编写使用示例和错误排查说明。


